{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h2><i class="fas fa-search-location"></i> Bus Tracking</h2>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-map"></i> Live Tracking Map</h5>
                </div>
                <div class="card-body">
                    <div id="tracking-map" style="height: 500px;"></div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-list"></i> Select Bus</h5>
                </div>
                <div class="card-body">
                    <select id="bus-select" class="form-select mb-3">
                        <option value="">Select a bus to track</option>
                        {% for bus in buses %}
                        <option value="{{ bus.id }}">{{ bus.bus_number }} - {{ bus.driver.username if bus.driver else 'No Driver' }}</option>
                        {% endfor %}
                    </select>
                    
                    <div id="bus-info" style="display: none;">
                        <div class="alert alert-info">
                            <h6 id="selected-bus-number"></h6>
                            <p id="selected-bus-driver"></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <h5><i class="fas fa-route"></i> Route Stops</h5>
                </div>
                <div class="card-body">
                    <div id="route-stops">
                        <p class="text-muted">Select a bus to view stops</p>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <h5><i class="fas fa-hand-paper"></i> Quick Actions</h5>
                </div>
                <div class="card-body">
                    <button id="find-nearest-stop" class="btn btn-info w-100 mb-2" disabled>
                        <i class="fas fa-location-arrow"></i> Find Nearest Stop
                    </button>
                    <button id="wait-request-btn" class="btn btn-warning w-100" disabled>
                        <i class="fas fa-hand-paper"></i> Send Wait Request
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Wait Request Modal -->
<div class="modal fade" id="waitRequestModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Send Wait Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="wait-request-form">
                    <div class="mb-3">
                        <label for="stop-select" class="form-label">Select Stop</label>
                        <select id="stop-select" class="form-select" required>
                            <option value="">Choose a stop</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="request-message" class="form-label">Message (Optional)</label>
                        <textarea id="request-message" class="form-control" rows="3" placeholder="I'm running a bit late..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="send-wait-request">Send Request</button>
            </div>
        </div>
    </div>
</div>

<script>
let trackingMap, selectedBusId, selectedBusMarker, routeStops = [];
let userLocation = null;

function initTrackingMap() {
    trackingMap = L.map('tracking-map').setView([11.1083711,76.992266], 9.67);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(trackingMap);
    
    // Get user location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            
            // Add user location marker
            const userMarker = L.marker([userLocation.lat, userLocation.lng], {
                icon: L.divIcon({
                    className: 'user-location-marker',
                    html: '<i class="fas fa-user" style="color: #e74c3c; font-size: 18px;"></i>',
                    iconSize: [25, 25],
                    iconAnchor: [12, 12]
                })
            }).addTo(trackingMap);
            
            userMarker.bindPopup('Your Location');
            trackingMap.setView([userLocation.lat, userLocation.lng], 14);
        });
    }
}

function loadSelectedBus() {
    const busSelect = document.getElementById('bus-select');
    selectedBusId = busSelect.value;
    
    if (!selectedBusId) {
        document.getElementById('bus-info').style.display = 'none';
        document.getElementById('route-stops').innerHTML = '<p class="text-muted">Select a bus to view stops</p>';
        document.getElementById('find-nearest-stop').disabled = true;
        document.getElementById('wait-request-btn').disabled = true;
        
        if (selectedBusMarker) {
            trackingMap.removeLayer(selectedBusMarker);
        }
        return;
    }
    
    // Show bus info
    const selectedOption = busSelect.options[busSelect.selectedIndex];
    const busNumber = selectedOption.text.split(' - ')[0];
    const driver = selectedOption.text.split(' - ');
    
    document.getElementById('selected-bus-number').textContent = busNumber;
    document.getElementById('selected-bus-driver').textContent = `Driver: ${driver}`;
    document.getElementById('bus-info').style.display = 'block';
    
    // Enable buttons
    document.getElementById('find-nearest-stop').disabled = false;
    document.getElementById('wait-request-btn').disabled = false;
    
    // Load bus location and route
    loadBusLocation(selectedBusId);
    loadRouteStops(selectedBusId);
    
    // Start tracking updates
    setInterval(() => loadBusLocation(selectedBusId), 10000);
}

function loadBusLocation(busId) {
    fetch('/api/bus_locations')
        .then(response => response.json())
        .then(buses => {
            const bus = buses.find(b => b.id == busId);
            if (bus) {
                // Remove existing marker
                if (selectedBusMarker) {
                    trackingMap.removeLayer(selectedBusMarker);
                }
                
                // Add new marker
                selectedBusMarker = L.marker([bus.lat, bus.lng], {
                    icon: L.divIcon({
                        className: 'selected-bus-marker',
                        html: '<i class="fas fa-bus" style="color: #007bff; font-size: 24px;"></i>',
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    })
                }).addTo(trackingMap);
                
                selectedBusMarker.bindPopup(`
                    <b>${bus.bus_number}</b><br>
                    Driver: ${bus.driver}<br>
                    Last Updated: ${new Date(bus.last_updated).toLocaleTimeString()}
                `);
                
                trackingMap.setView([bus.lat, bus.lng], 15);
            }
        });
}

function loadRouteStops(busId) {
    fetch(`/api/routes/${busId}`)
        .then(response => response.json())
        .then(stops => {
            routeStops = stops;
            const stopsDiv = document.getElementById('route-stops');
            stopsDiv.innerHTML = '';
            
            // Update stop select in modal
            const stopSelect = document.getElementById('stop-select');
            stopSelect.innerHTML = '<option value="">Choose a stop</option>';
            
            stops.forEach(stop => {
                // Add to route stops display
                const stopDiv = document.createElement('div');
                stopDiv.className = 'mb-2 p-2 border rounded';
                
                let etaText = 'Calculating...';
                if (stop.eta !== null) {
                    etaText = stop.eta > 0 ? `${stop.eta} min` : 'Arrived';
                }
                
                stopDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${stop.name}</strong><br>
                            <small class="text-muted">Scheduled: ${stop.estimated_time}</small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-info">ETA: ${etaText}</span>
                        </div>
                    </div>
                `;
                stopsDiv.appendChild(stopDiv);
                
                // Add to modal select
                const option = document.createElement('option');
                option.value = stop.id;
                option.textContent = `${stop.name} (${etaText})`;
                stopSelect.appendChild(option);
                
                // Add marker to map
                const stopMarker = L.marker([stop.lat, stop.lng], {
                    icon: L.divIcon({
                        className: 'stop-marker',
                        html: `<div style="background: #28a745; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px;">${stop.stop_order}</div>`,
                        iconSize: [25, 25],
                        iconAnchor: [12, 12]
                    })
                }).addTo(trackingMap);
                
                stopMarker.bindPopup(`
                    <b>${stop.name}</b><br>
                    Order: ${stop.stop_order}<br>
                    Scheduled: ${stop.estimated_time}<br>
                    ETA: ${etaText}
                `);
            });
            
            if (stops.length === 0) {
                stopsDiv.innerHTML = '<p class="text-muted">No stops found for this route</p>';
            }
        });
}

function findNearestStop() {
    if (!userLocation || routeStops.length === 0) {
        alert('Location not available or no stops loaded');
        return;
    }
    
    let nearestStop = null;
    let minDistance = Infinity;
    
    routeStops.forEach(stop => {
        const distance = calculateDistance(userLocation.lat, userLocation.lng, stop.lat, stop.lng);
        if (distance < minDistance) {
            minDistance = distance;
            nearestStop = stop;
        }
    });
    
    if (nearestStop) {
        trackingMap.setView([nearestStop.lat, nearestStop.lng], 16);
        alert(`Nearest stop: ${nearestStop.name} (${Math.round(minDistance)}m away)`);
    }
}

function calculateDistance(lat1, lng1, lat2, lng2) {
    const R = 6371000; // Earth's radius in meters
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLng/2) * Math.sin(dLng/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function sendWaitRequest() {
    const stopId = document.getElementById('stop-select').value;
    const message = document.getElementById('request-message').value;
    
    if (!stopId) {
        alert('Please select a stop');
        return;
    }
    
    fetch('/api/wait_request', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            bus_id: selectedBusId,
            stop_id: stopId,
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Wait request sent successfully!');
            bootstrap.Modal.getInstance(document.getElementById('waitRequestModal')).hide();
            document.getElementById('wait-request-form').reset();
        } else {
            alert(data.error || 'Error sending wait request');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error sending wait request');
    });
}

// Event listeners
document.getElementById('bus-select').addEventListener('change', loadSelectedBus);
document.getElementById('find-nearest-stop').addEventListener('click', findNearestStop);
document.getElementById('wait-request-btn').addEventListener('click', () => {
    const modal = new bootstrap.Modal(document.getElementById('waitRequestModal'));
    modal.show();
});
document.getElementById('send-wait-request').addEventListener('click', sendWaitRequest);

// Initialize map when page loads
document.addEventListener('DOMContentLoaded', initTrackingMap);
</script>
{% endblock %}
